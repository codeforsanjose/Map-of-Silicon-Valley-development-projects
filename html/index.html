<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <title>App</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Lato:400,700&display=swap" rel="stylesheet">
  <!-- Mapbox -->
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.css' rel='stylesheet' />

  <style>
  /* Opinionated Defaults */
  html{color:#222;font-size:1em;line-height:1.4}::-moz-selection{background:#b3d4fc;text-shadow:none}::selection{background:#b3d4fc;text-shadow:none}hr{display:block;height:1px;border:0;border-top:1px solid #ccc;margin:1em 0;padding:0}audio,canvas,iframe,img,svg,video{vertical-align:middle}fieldset{border:0;margin:0;padding:0}textarea{resize:vertical}@media print{*,*:before,*:after{background:transparent!important;color:#000!important;-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}a,a:visited{text-decoration:underline}a[href]:after{content:" (" attr(href) ")"}abbr[title]:after{content:" (" attr(title) ")"}a[href^="#"]:after,a[href^="javascript:"]:after{content:""}pre{white-space:pre-wrap!important}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}p,h2,h3{orphans:3;widows:3}h2,h3{page-break-after:avoid}}
  </style>

  <style>

  /* general styles */

  * {
    box-sizing: border-box;
  }

  a {
    color: #27718e;
  }

  body {
    overflow: hidden;
    font-family: 'Lato',Arial,Helvetica Neue,Helvetica,sans-serif;
    color: #283B62;
  }

  #map {
    position:absolute; top:0; bottom:0; left: 0; right: 0; width:100%; z-index: 1;
    transition: filter 0.2s;
    will-change: filter;
  }

  /* layout */

  .no-margin {
    margin: 0;
  }

  /* Tooltips */

  [tooltip]::before {
    content: "";
    position: absolute;
    left:50%;
    top: 100%;
    /* margin-top: 8px; */
    transform: translateX(-50%) translatey(-100%) rotate(-180deg);
    border-width: 4px 6px 0 6px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.7) transparent transparent transparent;
    opacity: 0;
  }
  [tooltip]::after {
    content: attr(tooltip);
    position: absolute;
    left: -15%;
    top: 100%;
    /* margin-top: 8px; */
    transform: translateX(-50%) translateY(0%);
    background: rgba(0, 0, 0, 0.7);
    text-align: center;
    color: #fff;
    padding: 4px;
    font-size: 1em;
    min-width: 170px;
    border-radius: 5px;
    pointer-events: none;
    opacity:0;
  }

  [tooltip]:hover::after,
  [tooltip]:hover::before {
     opacity:1
  }

  [tooltip]:active::after,
  [tooltip]:active::before {
     opacity:1
  }

  /* loading screen */

  .loader {
    position: absolute;
    top: 0;
    bottom: 0;
    right: 0;
    left: 0;
    z-index: 200;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #fff;
    flex-direction: column;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    will-change: opacity;
  }

  .loader.hidden {
    display: none;
  }

  .loader-title {
    will-change: transform;
    font-weight: 400;
  }

  .loader-title strong {
    color: #F0B50C;
  }

  .lds-dual-ring {
    display: inline-block;
    width: 64px;
    height: 64px;
    will-change: transform;
  }

  .lds-dual-ring:after {
    content: " ";
    display: block;
    width: 51px;
    height: 51px;
    margin: 1px;
    border-radius: 50%;
    border: 5px solid #48647c;
    border-color: #48647c transparent #48647c transparent;
    animation: lds-dual-ring 1.2s linear infinite;
  }

  /* Map View/List View picker menu */

  .view-menu {
    text-align: center;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    padding: 0.5em;
    pointer-events: none;
    z-index: 3;
    transition: background-color 0.2s;
  }

  .view-menu.list {
    background-color: #000;
    pointer-events: auto;
  }

  .view-btn {
    pointer-events: auto;
    background: #fff;
    border: 1px solid #ccc;
    padding: 0.5em;
    cursor: pointer;
  }

  .view-btn.active {
    background: #283B62;
    color: #fff;
    text-shadow: -1px -1px #000;
    border: 1px solid #000;
  }

  .view-btn:hover {
    border: 1px solid #000;
    opacity: 0.8;
  }

  .view-btn.active:hover {
    opacity: 1;
  }

  /* Flyout sidebar where marker info is displayed */

  .sidebar {
    position: absolute;
    right: 1em;
    top: 1em;
    width: 50%;
    min-width: 12em;
    transform: translateX(0);
    transition: transform 0.25s ease-in-out;
    z-index: 200;
  }

  .sidebar.hidden {
    transform: translateX(200%);
  }

  .sidebar .content {
    overflow-y: auto;
    max-height: 90vh;
    border-top: 4px solid #617482;
    position: relative;
    background: #fff;
    padding: 1em;
    pointer-events: auto;
    opacity: 1;
    word-wrap: break-word;
    box-shadow: 0px 1px 3px #00000069;
  }

  .sidebar .title {
    padding-bottom: 0.5em;
    border-bottom: 1px solid #ccc;
  }

  .sidebar .status {
    border-bottom: 1px solid #ccc;
    padding-bottom: 1.1em;
    text-align: center;
    display: flex;
    justify-content: space-between;
  }

  .sidebar .status-tag {
    background: #000;
    padding: 0.3em 0.7em;
    color: #fff;
    margin-right: 0.5em;
    display: inline-block;
  }

  .sidebar .status-detail {
    margin-right: 0.5em;
    max-width: 60%;
  }

  .sidebar .status-explain {
    font-size: 0.8em;
    font-style: italic;
    position: relative;
  }

  .sidebar .address {
    font-style: italic;
  }

  .sidebar .action-btn {
    display: inline-block;
    padding: 0.35em 1.2em;
    border: 2px solid #1995a6;
    border-radius: 1px;
    text-decoration: none;
    margin: 0 0.4em 0.5em 0;
    color: #1995a6;
    text-align: center;
    transition: background-color 0.2s, color 0.2s;
  }

  .sidebar .action-btn:hover {
    color: #fff;
    background-color: #1995a6;
  }

  .sidebar .close-btn {
    position: absolute;
    color: #777;
    font-size: 1em;
    right: 0;
    padding: 0.5em;
    top: 0;
    border: 0;
    cursor: pointer;
    background-color: transparent;
  }

  .sidebar .close-btn:hover {
    color: #555;
  }

  /* map legend */

  .legend {
    position: absolute;
    right: 1em;
    bottom: 1em;
    background: #ffffffad;
    z-index: 2;
    padding: 1em;
    transition: opacity 0.2s ease-in-out;
    box-shadow: 1px 1px 3px #00000069;
  }

  .legend ul {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .legend span {
    width: 1em;
    height: 1em;
    display: inline-block;
    border-radius: 999px;
    margin-right: 0.5em;
  }

  .legend-title {
    margin: 0 0 0.5em;
    font-style: italic;
    font-weight: normal;
  }

  /* List View */

  .list-view {
    z-index: 2;
    position: absolute;
    overflow-y: auto;
    bottom: 0;
    /* equal to the height of the view menu bar background */
    top: 3.25em;
    width: 100%;
    transform: translateX(-110%);
    will-change: transform;
    transition: transform 0.2s ease, filter 0.2s ease;
  }

  .list-header {
  }

  .list-view.active {
    background: #fff;
    transform: translateX(0);
  }

  .list-content {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .list-content li {
    background: #fff;
    padding: 1em;
    border-bottom: 1px solid #ccc;
    cursor: pointer;
  }

  .list-content .active,
  .list-content .active:hover {
    background: #b4dee4;
  }

  .list-content li:hover {
    background: #ddd;
  }

  .list-content .status {
    background: #000;
    padding: 0.3em 0.7em;
    color: #fff;
    margin-right: 1em;
  }

  .list-content .title {
    display: inline-block;
    margin-right: 1em;
  }

  .list-content .address {
    font-style: italic;
    margin: 0;
    display: inline-block;
  }

  /* animation / effects */

  .darken {
    -webkit-filter: brightness(0.8);
    filter: brightness(0.8);
  }

  .transparent {
    opacity: 0.5;
  }

  .fade-in {
    animation: fadeIn ease 0.2s;
    -webkit-animation: fadeIn ease 0.2s;
  }

  .fade-out {
    animation: fadeOut ease 0.2s;
    -webkit-animation: fadeOut ease 0.2s;
  }

  .fade-out-slow {
    animation: fadeOut ease 1s;
    -webkit-animation: fadeOut ease 1s;
  }

  .fade-in-out {
    animation: fadeInOut ease 2s infinite;
    -webkit-animation: fadeInOut ease 2s infinite;
  }

  .slide-out-top {
    animation: slideOutTop ease 1s;
    -webkit-animation: slideOutTop ease 1s;
  }

  .slide-out-bottom {
    animation: slideOutBottom ease 1s;
    -webkit-animation: slideOutBottom ease 1s;
  }

  @keyframes slideOutTop{
    0% {
      transform: translateY(0);
    }
    100% {
      transform: translateY(-100vh);
    }
  }

  @keyframes slideOutBottom{
    0% {
      transform: translateY(0);
    }
    100% {
      transform: translateY(100vh);
    }
  }

  @keyframes lds-dual-ring {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  @keyframes fadeIn{
    0% {
      opacity:0;
    }
    100% {
      opacity:1;
    }
  }

  @-webkit-keyframes fadeIn {
    0% {
      opacity:0;
    }
    100% {
      opacity:1;
    }
  }

  @keyframes fadeOut{
    0% {
      opacity:1;
    }
    100% {
      opacity:0;
    }
  }

  @-webkit-keyframes fadeOut {
    0% {
      opacity:1;
    }
    100% {
      opacity:0;
    }
  }

  @keyframes fadeInOut{
    0% {
      opacity:1;
    }
    50% {
      opacity: 0;
    }
    100% {
      opacity:1;
    }
  }

  @-webkit-keyframes fadeInOut {
    0% {
      opacity:1;
    }
    50% {
      opacity: 0;
    }
    100% {
      opacity:1;
    }
  }

  /* Responsive Styles */

  /* tablet/small screens */
  @media screen and (max-width: 1200px) {

  }
  /* mobile */
  @media screen and (max-width: 768px) {
    .sidebar {
      width: 100%;
      left: 0;
      right: 0;
      top: 0;
    }

    .sidebar .content {
      max-height: 100vh;
    }

    .sidebar .close-btn {
      font-size: 1.1em;
    }
  }
  </style>

  <meta name="theme-color" content="#fafafa">
</head>

<body>
  <!--[if IE]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->

  <!-- Add your site or application content here -->
  <section class="loader">
    <h3 class="loader-title">Catalyze <strong>SV</strong></h3>
    <div class="lds-dual-ring"></div>
    <p class="fade-in-out">
      Loading
    </p>
  </section>
  <main id="map"></main>
  <nav class="view-menu"></nav>
  <aside class="sidebar hidden">
    <div class="content">
      <button class="close-btn">CLOSE [X]</button>
      <div class="info fade-in"></div>
    </div>
  </aside>
  <aside class="legend">
  </aside>
  <section id="list" class="list-view">
    <div class="list-header"></div>
  </section>

  <script>
    // Avoid `console` errors in browsers that lack a console.
    (function(){var e;var d=function(){};var b=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeline","timelineEnd","timeStamp","trace","warn"];var c=b.length;var a=(window.console=window.console||{});while(c--){e=b[c];if(!a[e]){a[e]=d}}}());
  </script>

  <script>
    function getUniqueFeatures(array, comparatorProperty) {
      const existingFeatureKeys = {};
      // Because features come from tiled vector data, feature geometries may be split
      // or duplicated across tile boundaries and, as a result, features may appear
      // multiple times in query results.
      const uniqueFeatures = array.filter(function(el) {
      if (existingFeatureKeys[el.properties[comparatorProperty]]) {
        return false;
      } else {
        existingFeatureKeys[el.properties[comparatorProperty]] = true;
        return true;
      }
      });

      return uniqueFeatures;
    }

    function generate_view_menu_item(view_type, id) {
      /*
      Creates a view menu navigation item to select the view type.
      Args: view_type (str) - the type of view to show for this button
            id (str) - the id of the view to retrieve in the event listener
      Return: btn (obj) - button dom element w/ attributes set
      */
      const btn = document.createElement('button');
      btn.textContent = view_type;
      btn.setAttribute('data-view-id', id);
      btn.classList.add('view-btn');

      return btn;
    }

    function generate_legend(phases, order) {
      /*
      Creates and populates the dom elements for the map legend / key
      Args: phases (obj) - obj containing name/color info for each label
            order (array) - array of keys = phases showing order to output
      Return: legend ul dom element (obj)
      */
      const legend_list = document.createElement('ul');

      // create the legend title
      const title = document.createElement('h4');
      title.classList.add('legend-title');
      title.textContent = 'Status With City';
      legend_list.append(title);

      order.forEach((current_item) => {
        // create labels and key colors per legend item
        let item_color = document.createElement('span');
        item_color.style.backgroundColor = phases[current_item];
        let list_item = document.createElement('li');
        list_item.textContent = current_item;

        // so the color appears first
        list_item.prepend(item_color);
        legend_list.append(list_item);
      });

      return legend_list
    }

    function generate_sidebar(marker_properties) {
      /*
      Creates the sidebar info element dom contents.
      Args: marker_properties (obj) - contains the properties for a given marker
      Return: template string literal (str) - html string to set the info template element to
      */
      let { Address,
             City,
             State,
             Phase,
             "Project Name" : project_name,
             "ZIP Code": Zip,
             "Type of Project/ Overview" : project_type,
             "Link to City Documents" : city_docs,
             "Date Presented to PAC" : presented_date,
             "Current Status in Catalyze SV" : catalyze_status,
             "Next Public Meeting" : next_meet,
             "Project Website" : website,
             "Owner/Developer Name" : developer,
             "Current Status With City" : detail_status,
             "Catalyze SV's Scorecard" : score,
             "Catalyze SV's Letter" : catalyze_letter,
           } = marker_properties;

      // show/hide some info dependent on if it is available in dataset
      const catalyze_letter_html = catalyze_letter && catalyze_letter !== ''
          ? `<a href=${catalyze_letter} class="action-btn" target="_blank" rel="noreferrer">Catalyze SV's Letter</a>`
          : '';
      const catalyze_scorecard_html = score && score !== ''
          ? `<a href=${score} class="action-btn" target="_blank" rel="noreferrer">View Catalyze SV Scorecard</a>`
          : '';
      const website_html = website && website !== ''
          ? `<a href=${website} class="action-btn" target="_blank" rel="noreferrer">View Project Website</a>`
          : '';
      const presented_date_html = presented_date && presented_date !== ''
          ? `<li>Presented to PAC on: ${presented_date}</li>`
          : '';
      const catalyze_status_html = catalyze_status && catalyze_status !== ''
          ? `<p>Catalyze SV Review Status: ${catalyze_status}</p>`
          : '';
      const next_meet_html = next_meet && next_meet !== ''
          ? `<li>Next Public Meeting: ${next_meet}</li>`
          : `<li>Next Public Meeting: TBD</li>`;
      const city_docs_html = city_docs && city_docs !== ''
          ? `<a href=${city_docs} class="action-btn" target="_blank" rel="noreferrer">View City Documents</a>`
          : '';

      const phase_color = data.phases[Phase];
      const tooltip = CONSTANTS.status_tip

      // template for the sidebar content
      return `
        <h3 class="title">${project_name}</h3>
        <p class="status">
          <span>
            <span class="status-tag" style="background:${phase_color}">${Phase}</span>
          </span>
          <span class="status-detail">${detail_status}</span>
          <span>
            <a href="#" class="status-explain" tooltip="${tooltip}">What's This?</a>
          </span>
        </p>
        <p class="address">
          ${Address}, ${City}, ${State} ${Zip}
        </p>
        <p>
          ${project_type}
        </p>
        <ul>
          <li>
            Owner/Developer: ${developer}
          </li>
          ${presented_date_html}
          ${next_meet_html}
        </ul>
        <hr />
        <h4>Resources & Links</h4>
        <p>
          Catalyze SV evaluates project sustainability, equitability, and vibrance. <a href="https://www.catalyzesv.org/projects">Learn about our project review process.</a>
        </p>
        ${catalyze_status_html}
        <p>
          ${catalyze_scorecard_html}
          ${catalyze_letter_html}
          ${city_docs_html}
          ${website_html}
        </p>`
    }

    function generate_list_view(map_features, phases) {
      /*
      Generates the ul dom element containing the list view of the projects on the
      map based on the map feature array passed in.
      Args: map_features (arr) - array of layer map geojson features from a mapbox layer
            phases (obj) - obj containing color data for each phase
      Return: list (obj) - ul dom element of the list view items
      */
      const list = document.createElement('ul');
      list.classList.add('list-content');

      map_features.forEach((current_item, i) => {
        let current_props = current_item.properties;
        let current_feature = document.createElement('li');
        // store the name to know which makrer's info to retrieve
        current_feature.setAttribute('data-name', current_props["Project Name"]);
        current_feature.setAttribute('data-index', i);

        let status_tag = document.createElement('span');
        status_tag.textContent = current_props["Phase"];
        status_tag.classList.add('status');
        // recolor according to phase
        status_tag.style.backgroundColor = phases[current_props['Phase']];

        let title = document.createElement('h3');
        title.textContent = current_props["Project Name"];
        title.classList.add('title');

        let address = document.createElement('p');
        address.textContent = current_props["Address"];
        address.classList.add('address');
        current_feature.append(status_tag, title, address);

        list.append(current_feature)
      });

      return list;
    }

    function make_name_popup(current_project) {
      /*
      Show the given popup on the map using info from a project.
      Args: current_project (obj) - a specific map feature element w/ geometry and properties,
            typically returned from an event listener -> event.features[0]
      Return: Popup (obj) - instance containing the coordinates and text for the marker
      */
      // need to instantiate a new Popup otherwise the mousover popups won't
      // allow the click triggered one to show and it'll interfere with animations
      const popup = new mapboxgl.Popup({
        closeButton: false,
        className: CONSTANTS.css.fade
      });

      popup.setLngLat(current_project.geometry.coordinates)
           .setText(current_project.properties['Project Name']);

      return popup
    }

    function play_sidebar_animation(sidebar_open) {
      /*
      Plays the corresponding sidebar animation for the sidebar dom element
      depending on if the sidebar is already open or not.
      Args: sidebar_open (bool) - whether the sidebar is open or not
      Return: na
      */
      // animate sidebar info change if sidebar already open
      if (sidebar_open) {
        // block applied css animation with an override
        sidebar_info.style.animation ='none';
        // trigger reflow so css animation can play again
        void sidebar_info.offsetWidth;
        // allow defined css animation to play again
        sidebar_info.style.animation = null;
      } else {
        // otherwise just show the sidebar
        state.sidebar_open = true;
        sidebar.classList.toggle(CONSTANTS.css.hidden);
        legend.classList.toggle(CONSTANTS.css.transparent);
        state.active_view.classList.toggle(CONSTANTS.css.darken);
      }
    }

    function show_sidebar(feature) {
      /*
      Show's the sidebar and the info in it for the currently selected feature/marker.
      Args: feature (obj) - the feature obj for the project to display info for w/ a properties obj
      Return: na
      */
      // clear existing content by looping through sidebar info children
      while (sidebar_info.firstChild) {
          sidebar_info.firstChild.remove();
      }

      // animate sidebar changes according to if the sidebar is already open
      play_sidebar_animation(state.sidebar_open);

      // sidebar elements container that can be innerHTML'ed
      const info_template = document.createElement('template');
      info_template.innerHTML = generate_sidebar(feature.properties);
      // makes the template element active so its visible in the dom
      const active_template = info_template.content.cloneNode(true);
      sidebar_info.append(active_template);
      // match border color with legend/icon colors for phases
      sidebar_content.style.borderColor = data.phases[feature.properties['Phase']];
    }

    function animate_popup_removal(popup) {
      /*
      Animates the removal of the popup by waiting for the animation to complete
      before removal.
      Args: popup (obj) - popup dom element to be animated/removed
      Return: na
      */
      popup.classList.toggle(CONSTANTS.css.fade_out);

      // named animationend callback so listener can be deleted to prevent memory leaks
      const remove_popup = (e) => {
        popup.removeEventListener('animationend', remove_popup);
        popup.remove();
      };

      // only remove popup after css animation completes
      popup.addEventListener('animationend', remove_popup);
    }

    function highlight_active_project(state, current_listing) {
      /*
      Highlights the currently selected project/marker in the list view.
      Args: state (obj) - the state obj containing state.active_project whether it's
              null or the feature obj that is currently active
            current_listing (obj) - the dom element in the list view corresponding
              to the feature to be made active
      Return: na
      */
      // if something's already highlighted, need to remove the highlight first
      if (state.active_project) {
        state.active_project.classList.remove(CONSTANTS.css.active)
        current_listing.classList.add(CONSTANTS.css.active);
      } else {
        current_listing.classList.add(CONSTANTS.css.active);
      }
      state.active_project = current_listing;
    }

    // =============== APP LOGIC ===============

    const state = {
      sidebar_open: false,
      markers_saved: false,
      active_tab: null,
      active_project: null,
      active_view: null
    }
    const CONSTANTS = {
      mapbox_key: 'pk.eyJ1Ijoic3VubnltdWkiLCJhIjoiY2sxcjhpMzY0MDJubTNtbzdic2pmZ29kYiJ9.i5wxeYoDcJponU7Pc3b-FQ',
      mapbox_style_url: 'mapbox://styles/sunnymui/ck1r9coyy0dxn1cpe1tgues9x',
      css: {
        hidden: 'hidden',
        transparent: 'transparent',
        fade: 'fade-in',
        fade_out: 'fade-out',
        fade_out_slow: 'fade-out-slow',
        slide_top: 'slide-out-top',
        slide_bottom: 'slide-out-bottom',
        darken: 'darken',
        active: 'active',
        list: 'list'
      },
      projects_layer: 'projects-catalyze-sv',
      projects_id_key: 'Project Name',
      status_tip: 'Developers submit applications to the City, get their design reviewed, do redesigns based on City & community feedback,  resubmit proposals for review, and get approval (though can even redesign after approval)'
    }
    const data = {
      features: [],
      // phase names and their associated colors
      phases: {
        'Application': '#555',
        'In Design': '#86619f',
        'In Review': '#268adb',
        'Approved': '#358c29'
      },
      // the order to output the legend items in
      legend_order: [
        'Application',
        'In Design',
        'In Review',
        'Approved'
      ],
      view_types: [{
          name: 'List View',
          id: 'list'
        }, {
          name: 'Map View',
          id: 'map'
      }]
    }

    // dom elements references
    const map_element = document.querySelector('#map');
    const sidebar = document.querySelector('.sidebar');
    const sidebar_content = document.querySelector('.sidebar .content');
    const sidebar_info = document.querySelector('.info');
    const close_btn = document.querySelector('.close-btn');
    const legend = document.querySelector('.legend');
    const list_view = document.querySelector('.list-view');
    const view_menu = document.querySelector('.view-menu');
    const loader = document.querySelector('.loader');
    const loader_text = document.querySelector('.loader p');
    const loader_title = document.querySelector('.loader .loader-title');

    // generate the map
    mapboxgl.accessToken = CONSTANTS.mapbox_key;
    const map = new mapboxgl.Map({
      container: 'map',
      style: CONSTANTS.mapbox_style_url,
      center: [-121.898395, 37.322972],
      zoom: 11
    });

    // wait for map to finish load before executing map functions
    map.on('load', () => {

      // ============ PRELOADER =============

      // animate hiding loader on map load
      loader.classList.add(CONSTANTS.css.fade_out_slow);
      loader_title.classList.add(CONSTANTS.css.slide_top);
      loader_text.classList.add(CONSTANTS.css.slide_bottom);

      // named animationend callback so listener can be deleted to prevent memory leaks
      const hide_loader = (e) => {
        loader.removeEventListener('animationend', hide_loader);
        loader.classList.add(CONSTANTS.css.hidden);
      };

      // hide loader after css animation completes
      loader.addEventListener('animationend', hide_loader);

      // ========= MAP UI CREATION ============

      // create the view type menu
      const view_contents = document.createDocumentFragment();
      data.view_types.forEach((current_item, i) => {
        let view_btn = generate_view_menu_item(current_item.name, current_item.id);
        // have map view button shown as active by default
        if (i === 1) {
          view_btn.classList.add(CONSTANTS.css.active);
          state.active_tab = view_btn;
          state.active_view = map_element;
        }
        view_contents.append(view_btn);
      });
      view_menu.append(view_contents);

      // create the legend element
      const legend_elements = generate_legend(data.phases, data.legend_order);
      legend.append(legend_elements);

      // store a popup reference to reassign/close/reopen in multiple events
      let popup = new mapboxgl.Popup({
        closeButton: false,
        className: CONSTANTS.css.fade
      });

      // Add zoom and rotation controls to the map.
      map.addControl(new mapboxgl.NavigationControl());

      // create the list view
      map.on('idle', () => {
        // only need to get the features once
        if(!state.markers_saved) {
          // grab the features on the projects layer
          const rendered_features = map.queryRenderedFeatures({layers: [CONSTANTS.projects_layer]});
          // filter any duplicates out by name and save the features for later use
          data.features = getUniqueFeatures(rendered_features, CONSTANTS.projects_id_key);

          const projects_list = generate_list_view(data.features, data.phases);
          list_view.append(projects_list);
          state.markers_saved = true;
        }
      });

      // ======= CONTROLS & INTERACTION ========

      // catch the target through event bubbling
      view_menu.addEventListener('click', (e) => {
        const view_type = e.target.getAttribute('data-view-id');

        // unhighlight current active tab then highlight clicked tab
        state.active_tab.classList.remove(CONSTANTS.css.active);
        state.active_tab = e.target;
        state.active_tab.classList.add(CONSTANTS.css.active);

        // switch view menu styles specific to the active view
        view_menu.classList.remove(state.active_view.id);
        view_menu.classList.add(view_type);

        // hide previous active view and show current active view
        state.active_view.classList.remove(CONSTANTS.css.active, CONSTANTS.css.darken);
        state.active_view = document.getElementById(view_type);
        state.active_view.classList.add(CONSTANTS.css.active)
        // if sidebar is open we need to apply darkening to current view
        if (state.sidebar_open) {
          state.active_view.classList.add(CONSTANTS.css.darken);
        }
      });

      list_view.addEventListener('click', (e) => {
        const current_listing = e.target.closest('li');
        const current_project_id = current_listing.getAttribute('data-index');
        const current_project = data.features[current_project_id];

        highlight_active_project(state, current_listing);

        show_sidebar(current_project);
        // must remove existing popup cuz multiple of these can be showing
        popup.remove();
        popup = make_name_popup(current_project).addTo(map);
      });

      // When a click event occurs on a marker in the projects layer, show info
      map.on('click', CONSTANTS.projects_layer, (e) => {

        const current_project = e.features[0];
        const current_project_name = current_project.properties[CONSTANTS.projects_id_key];
        const current_listing = document.querySelector(`.list-view li[data-name="${current_project_name}"]`);

        highlight_active_project(state, current_listing);

        show_sidebar(current_project);
        popup = make_name_popup(current_project).addTo(map);
      });

      close_btn.addEventListener('click', () => {

        // hide the sidebar on click
        state.sidebar_open = false;
        sidebar.classList.toggle(CONSTANTS.css.hidden);
        // remove deemphasizing styles
        legend.classList.toggle(CONSTANTS.css.transparent);
        state.active_view.classList.remove(CONSTANTS.css.darken);
        // clear active
        state.active_project.classList.remove(CONSTANTS.css.active)
        state.active_project = null;

        // remove current popup element after animation ends
        animate_popup_removal(popup.getElement());
      });

      map.on('mouseenter', CONSTANTS.projects_layer, function (e) {
        // Change the cursor to a pointer when the mouse is over the projects layer
        map.getCanvas().style.cursor = 'pointer';

        // don't want mouseovers to change the opened popup when sidebar is open
        if (!state.sidebar_open) {
          popup = make_name_popup(e.features[0]).addTo(map);
        }
      });

      map.on('mouseleave', CONSTANTS.projects_layer, function (e) {
        // Change it back to a cursor when it leaves
        map.getCanvas().style.cursor = '';

        // don't want mouseovers to change the opened popup when sidebar is open
        if (!state.sidebar_open) {
          popup.remove();
        }
      });
    });

  </script>

</body>

</html>
