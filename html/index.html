<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <title>App</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />
  <!-- Mapbox -->
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.css' rel='stylesheet' />

  <style>
  /* Opinionated Defaults */
  html{color:#222;font-size:1em;line-height:1.4}::-moz-selection{background:#b3d4fc;text-shadow:none}::selection{background:#b3d4fc;text-shadow:none}hr{display:block;height:1px;border:0;border-top:1px solid #ccc;margin:1em 0;padding:0}audio,canvas,iframe,img,svg,video{vertical-align:middle}fieldset{border:0;margin:0;padding:0}textarea{resize:vertical}@media print{*,*:before,*:after{background:transparent!important;color:#000!important;-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}a,a:visited{text-decoration:underline}a[href]:after{content:" (" attr(href) ")"}abbr[title]:after{content:" (" attr(title) ")"}a[href^="#"]:after,a[href^="javascript:"]:after{content:""}pre{white-space:pre-wrap!important}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}p,h2,h3{orphans:3;widows:3}h2,h3{page-break-after:avoid}}
  </style>

  <style>

  /* general styles */

  body {
    overflow: hidden;
    font-family: Arial,Helvetica Neue,Helvetica,sans-serif;
  }

  #map {
    position:absolute; top:0; bottom:0; width:100%; z-index: 1;
    transition: filter 0.3s;
    will-change: filter;
  }

  /* layout */

  .no-margin {
    margin: 0;
  }

  /* Map View/List View picker menu */

  .view-menu {
    position: absolute;
    z-index: 2;
    left: 50%;
    transform: translateX(-50%);
  }

  /* Flyout sidebar where marker info is displayed */

  .sidebar {
    position: absolute;
    right: 1em;
    top: 1em;
    width: 40%;
    min-width: 12em;
    transform: translateX(0);
    transition: transform 0.3s ease-in-out;
    z-index: 200;
  }

  .sidebar.hidden {
    transform: translateX(200%);
  }

  .content {
    overflow-y: auto;
    max-height: 90vh;
    border-top: 3px solid #617482;
    position: relative;
    background: #fff;
    padding: 1em;
    pointer-events: auto;
    opacity: 1;
    word-wrap: break-word;
    box-shadow: 1px 1px 3px #00000069;
  }

  .close-btn {
    position: absolute;
    color: #888;
    font-size: 1em;
    right: 0;
    padding: 0.5em;
    top: 0;
    border: 0;
    cursor: pointer;
    background-color: transparent;
  }

  .close-btn:hover {
    color: #555;
  }

  /* map legend */

  .legend {
    position: absolute;
    right: 1em;
    bottom: 1em;
    background: #ffffffad;
    z-index: 100;
    padding: 1em;
    transition: opacity 0.3s ease-in-out;
    box-shadow: 1px 1px 3px #00000069;
  }

  .legend ul {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .legend span {
    width: 1em;
    height: 1em;
    display: inline-block;
    border-radius: 999px;
    margin-right: 0.5em;
  }

  .legend-title {
    margin: 0 0 0.5em;
    font-style: italic;
    font-weight: normal;
  }

  /* List View */

  .list-view {
    position: absolute;
    overflow-y: auto;
    height: 100%;
  }

  .list-content {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .list-content li {
    background: #fff;
    padding: 1em;
    border-bottom: 1px solid #000;
  }

  /* animation / effects */

  .darken {
    -webkit-filter: brightness(0.8);
    filter: brightness(0.8);
  }

  .transparent {
    opacity: 0.5;
  }

  .fade-in {
    animation: fadeIn ease 0.2s;
    -webkit-animation: fadeIn ease 0.2s;
  }

  .fade-out {
    animation: fadeOut ease 0.1s;
    -webkit-animation: fadeOut ease 0.1s;
  }

  @keyframes fadeIn{
    0% {
      opacity:0;
    }
    100% {
      opacity:1;
    }
  }

  @-webkit-keyframes fadeIn {
    0% {
      opacity:0;
    }
    100% {
      opacity:1;
    }
  }

  @keyframes fadeOut{
    0% {
      opacity:1;
    }
    100% {
      opacity:0;
    }
  }

  @-webkit-keyframes fadeOut {
    0% {
      opacity:1;
    }
    100% {
      opacity:0;
    }
  }
  </style>

  <meta name="theme-color" content="#fafafa">
</head>

<body>
  <!--[if IE]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->

  <!-- Add your site or application content here -->
  <main id="map"></main>
  <nav class="view-menu"></nav>
  <aside class="sidebar hidden">
    <div class="content">
      <button class="close-btn">X</button>
      <div class="info fade-in"></div>
    </div>
  </aside>
  <aside class="legend">
  </aside>
  <section class="list-view">
  </section>

  <script>
    // Avoid `console` errors in browsers that lack a console.
    (function(){var e;var d=function(){};var b=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeline","timelineEnd","timeStamp","trace","warn"];var c=b.length;var a=(window.console=window.console||{});while(c--){e=b[c];if(!a[e]){a[e]=d}}}());
  </script>

  <script>
    function getUniqueFeatures(array, comparatorProperty) {
      const existingFeatureKeys = {};
      // Because features come from tiled vector data, feature geometries may be split
      // or duplicated across tile boundaries and, as a result, features may appear
      // multiple times in query results.
      const uniqueFeatures = array.filter(function(el) {
      if (existingFeatureKeys[el.properties[comparatorProperty]]) {
        return false;
      } else {
        existingFeatureKeys[el.properties[comparatorProperty]] = true;
        return true;
      }
      });

      return uniqueFeatures;
    }

    function generate_view_menu() {
      /*
      */
      const fragment = document.createDocumentFragment();

      const list_btn = document.createElement('button');
      const map_btn = document.createElement('button');

      list_btn.textContent = 'List View';
      map_btn.textContent = 'Map View'

      list_btn.classList.add('show-list');
      map_btn.classList.add('show-map');

      list_btn.addEventListener('click', ()=>{
        console.log('list clicked');
      });

      map_btn.addEventListener('click', ()=>{
        console.log('map clicked');
      });

      fragment.append(list_btn, map_btn);

      return fragment;
    }

    function generate_legend(legend_items) {
      /*
      Creates and populates the dom elements for the map legend / key
      Args: legend_items (array) - array of objs containing name/color info for each label
      Return: legend ul dom element (obj)
      */
      const legend_list = document.createElement('ul');

      legend_items.forEach((current_item) => {
        if (!current_item.name) {
          // create the legend title
          const title = document.createElement('h4');
          title.classList.add(current_item.css);
          title.textContent = current_item.title;
          legend_list.prepend(title);
        } else {
          // create labels and key colors per legend item
          let item_color = document.createElement('span');
          item_color.style.backgroundColor = current_item.color;
          let list_item = document.createElement('li');
          list_item.textContent = current_item.name;

          // so the color appears first
          list_item.prepend(item_color);
          legend_list.append(list_item);
        }
      });

      return legend_list
    }

    function generate_sidebar(marker_properties) {
      /*
      Creates the sidebar info element dom contents.
      Args: marker_properties (obj) - contains the properties for a given marker
      Return: template string literal (str) - html string to set the info template element to
      */
      let { Address,
             City,
             State,
             Phase,
             "Project Name" : project_name,
             "ZIP Code": Zip,
             "Type of Project/ Overview" : project_type,
             "Link to City Documents" : city_docs,
             "Date Presented to PAC" : presented_date,
             "Current Status in Catalyze SV" : catalyze_status,
             "Next Public Meeting" : next_meet,
             "Project Website" : website,
             "Owner/Developer Name" : developer,
             "Current Status With City" : detail_status,
             "Catalyze SV's Scorecard" : score,
             "Catalyze SV's Letter" : catalyze_letter,
           } = marker_properties;

      // template for the sidebar content
      return `
        <h3>${project_name}</h3>
        <p>
          <em>
            ${Address}, ${City}, ${State} ${Zip}
          </em>
        </p>
        <p>
          ${project_type}
        </p>
        <ul>
          <li>
            Developer: ${developer}
          </li>
          <li>
            Status: ${Phase}
          </li>
          <li>
            Status Details: ${detail_status}
          </li>
          <li>
            Catalyze SV Status: ${catalyze_status}
          </li>
          <li>
            Score: ${score}
          </li>
          <li>
            Catalyze SV Letter: ${catalyze_letter}
          </li>
          <li>
            Presented to PAC: ${presented_date}
          </li>
          <li>
            Next Meeting: ${next_meet}
          </li>
          <li>
            City Documents: ${city_docs}
          </li>
          <li>
            Website: ${website}
          </li>
        </ul>`
    }

    function generate_list_view(map_features) {
      /*
      Generates the ul dom element containing the list view of the projects on the
      map based on the map feature array passed in.
      Args: map_features (arr) - array of layer map geojson features from a mapbox layer
      Return: list (obj) - ul dom element of the list view items
      */
      const list = document.createElement('ul');
      list.classList.add('list-content');

      map_features.forEach((current_item) => {
        let current_feature = document.createElement('li');
        current_feature.setAttribute('data-name', current_item.properties["Project Name"])
        // need to add a click handler event
        current_feature.textContent = current_item.properties["Project Name"];
        list.append(current_feature)
      });

      return list;
    }

    function make_name_popup(current_project) {
      /*
      Show the given popup on the map using info from a project.
      Args: current_project (obj) - a specific map feature element w/ geometry and properties,
            typically returned from an event listener -> event.features[0]
      Return: Popup (obj) - instance containing the coordinates and text for the marker
      */
      // need to instantiate a new Popup otherwise the mousover popups won't
      // allow the click triggered one to show and it'll interfere with animations
      const popup = new mapboxgl.Popup({
        closeButton: false,
        className: CONSTANTS.css.fade
      });

      popup.setLngLat(current_project.geometry.coordinates)
           .setText(current_project.properties['Project Name']);

      return popup
    }

    function play_sidebar_animation(sidebar_open) {
      /*
      Plays the corresponding sidebar animation for the sidebar dom element
      depending on if the sidebar is already open or not.
      Args: sidebar_open (bool) - whether the sidebar is open or not
      Return: na
      */
      // animate sidebar info change if sidebar already open
      if (sidebar_open) {
        // block applied css animation with an override
        sidebar_info.style.animation ='none';
        // trigger reflow so css animation can play again
        void sidebar_info.offsetWidth;
        // allow defined css animation to play again
        sidebar_info.style.animation = null;
      } else {
        // otherwise just show the sidebar
        state.sidebar_open = true;
        sidebar.classList.toggle(CONSTANTS.css.hidden);
        legend.classList.toggle(CONSTANTS.css.transparent);
        map_element.classList.toggle('darken');
      }
    }

    function animate_popup_removal(popup) {
      /*
      Animates the removal of the popup by waiting for the animation to complete
      before removal.
      Args: popup (obj) - popup dom element to be animated/removed
      Return: na
      */
      popup.classList.toggle(CONSTANTS.css.fade_out);

      // named animationend callback so listener can be deleted to prevent memory leaks
      const remove_popup = (e) => {
        popup.removeEventListener('animationend', remove_popup);
        popup.remove();
      };

      // only remove popup after css animation completes
      popup.addEventListener('animationend', remove_popup);
    }

    // =============== APP LOGIC ===============

    const state = {
      sidebar_open: false,
      markers_saved: false
    }
    const CONSTANTS = {
      mapbox_key: 'pk.eyJ1Ijoic3VubnltdWkiLCJhIjoiY2sxcjhpMzY0MDJubTNtbzdic2pmZ29kYiJ9.i5wxeYoDcJponU7Pc3b-FQ',
      mapbox_style_url: 'mapbox://styles/sunnymui/ck1r9coyy0dxn1cpe1tgues9x',
      css: {
        hidden: 'hidden',
        transparent: 'transparent',
        fade: 'fade-in',
        fade_out: 'fade-out'
      },
      projects_layer: 'projects-catalyze-sv'
    }
    const data = {
      features: [],
      // colors and labels to use for the legend
      legend: [{
        title: 'Status With City',
        css: 'legend-title'
      }, {
        name: 'Application',
        color: '#555'
      }, {
        name: 'In Design',
        color: '#86619f'
      }, {
        name: 'Under Review',
        color: '#268adb'
      }, {
        name: 'Approved',
        color: '#358c29'
      }]
    }

    // dom elements references
    const map_element = document.querySelector('#map');
    const sidebar = document.querySelector('.sidebar');
    const sidebar_info = document.querySelector('.info');
    const close_btn = document.querySelector('.close-btn');
    const legend = document.querySelector('.legend');
    const list_view = document.querySelector('.list-view');
    const view_menu = document.querySelector('.view-menu');

    // generate the map
    mapboxgl.accessToken = CONSTANTS.mapbox_key;
    const map = new mapboxgl.Map({
      container: 'map',
      style: CONSTANTS.mapbox_style_url,
      center: [-121.898395, 37.322972],
      zoom: 11
    });

    // wait for map to finish load before executing map functions
    map.on('load', () => {

      // ========= MAP UI CREATION ============

      // create the view type menu
      view_menu.append(generate_view_menu());

      // create the legend element
      const legend_elements = generate_legend(data.legend);
      legend.append(legend_elements);

      // store a popup reference to reassign/close/reopen in multiple events
      let popup = new mapboxgl.Popup({
        closeButton: false,
        className: CONSTANTS.css.fade
      });

      // to hold the sidebar elements before append
      const info_template = document.createElement('template');

      // Add zoom and rotation controls to the map.
      map.addControl(new mapboxgl.NavigationControl());

      map.on('idle', () => {
        // only need to get the features once
        if(!state.markers_saved) {
          // grab the features on the projects layer
          const rendered_features = map.queryRenderedFeatures({layers: [CONSTANTS.projects_layer]});
          // filter any duplicates out by name and save the features for later use
          data.features = getUniqueFeatures(rendered_features, "Project Name");
          console.log(data.features);

          const projects_list = generate_list_view(data.features);
          list_view.append(projects_list);
          state.markers_saved = true;
        }
      });

      // ======= CONTROLS & INTERACTION ========

      // When a click event occurs on a marker in the projects layer, show info
      map.on('click', CONSTANTS.projects_layer, (e) => {

        const current_project = e.features[0];

        // clear existing content by looping through sidebar info children
        while (sidebar_info.firstChild) {
            sidebar_info.firstChild.remove();
        }

        // animate sidebar changes according to if the sidebar is already open
        play_sidebar_animation(state.sidebar_open);

        info_template.innerHTML = generate_sidebar(current_project.properties);
        // makes the template element active so its visible in the dom
        const active_template = info_template.content.cloneNode(true);
        sidebar_info.append(active_template);

        popup = make_name_popup(current_project).addTo(map);
      });

      close_btn.addEventListener('click', () => {
        // hide the sidebar on click
        state.sidebar_open = false;
        sidebar.classList.toggle(CONSTANTS.css.hidden);
        // deemphasize the legend
        legend.classList.toggle(CONSTANTS.css.transparent);
        map_element.classList.toggle('darken');

        // remove current popup element after animation ends
        animate_popup_removal(popup.getElement());
      });

      map.on('mouseenter', CONSTANTS.projects_layer, function (e) {
        // Change the cursor to a pointer when the mouse is over the projects layer
        map.getCanvas().style.cursor = 'pointer';

        // don't want mouseovers to change the opened popup when sidebar is open
        if (!state.sidebar_open) {
          popup = make_name_popup(e.features[0]).addTo(map);
        }
      });

      map.on('mouseleave', CONSTANTS.projects_layer, function (e) {
        // Change it back to a cursor when it leaves
        map.getCanvas().style.cursor = '';

        // don't want mouseovers to change the opened popup when sidebar is open
        if (!state.sidebar_open) {
          // popup.remove();
          animate_popup_removal(popup.getElement());
        }
      });
    });

  </script>

</body>

</html>
