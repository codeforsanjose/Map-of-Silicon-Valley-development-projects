<!doctype html>
<html class="no-js" lang="en">

<head>
  <meta charset="utf-8">
  <title>Catalyze SV Project Tracker Map</title>
  <meta name="description" content="Maps development projects in the Silicon Valley area and shares Catalyze SV project scores/evaluations for each">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
  <link href="https://fonts.googleapis.com/css?family=Lato:400,700&display=swap" rel="stylesheet">
  <!-- Mapbox -->
  <link rel="preconnect" href="https://api.mapbox.com/" crossorigin>
  <link rel="preconnect" href="https://events.mapbox.com/" crossorigin>
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.css' rel='stylesheet' />

  <style>
  /* Opinionated Defaults */
  html{color:#222;font-size:1em;line-height:1.4}::-moz-selection{background:#b3d4fc;text-shadow:none}::selection{background:#b3d4fc;text-shadow:none}hr{display:block;height:1px;border:0;border-top:1px solid #ccc;margin:1em 0;padding:0}audio,canvas,iframe,img,svg,video{vertical-align:middle}fieldset{border:0;margin:0;padding:0}textarea{resize:vertical}@media print{*,*:before,*:after{background:transparent!important;color:#000!important;-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}a,a:visited{text-decoration:underline}a[href]:after{content:" (" attr(href) ")"}abbr[title]:after{content:" (" attr(title) ")"}a[href^="#"]:after,a[href^="javascript:"]:after{content:""}pre{white-space:pre-wrap!important}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}p,h2,h3{orphans:3;widows:3}h2,h3{page-break-after:avoid}}
  </style>

  <style>

  /* general styles */

  * {
    box-sizing: border-box;
  }

  a {
    color: #27718e;
  }

  body {
    overflow: hidden;
    font-family: 'Lato',Arial,Helvetica Neue,Helvetica,sans-serif;
    color: #283B62;
  }

  #map {
    position:absolute; top:0; bottom:0; left: 0; right: 0; width:100%; z-index: 1;
    transition: filter 0.2s;
    will-change: filter;
  }

  /* layout */

  .no-margin {
    margin: 0;
  }

  /* Tooltips */

  [tooltip]::before {
    content: "";
    position: absolute;
    left:50%;
    top: 100%;
    /* margin-top: 8px; */
    transform: translateX(-50%) translatey(-100%) rotate(-180deg);
    border-width: 4px 6px 0 6px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.7) transparent transparent transparent;
    opacity: 0;
  }
  [tooltip]::after {
    content: attr(tooltip);
    position: absolute;
    right: -7em;
    top: 100%;
    /* margin-top: 8px; */
    transform: translateX(-50%) translateY(0%);
    background: rgba(0, 0, 0, 0.7);
    text-align: center;
    color: #fff;
    padding: 4px;
    font-size: 1em;
    min-width: 170px;
    border-radius: 5px;
    pointer-events: none;
    opacity:0;
  }

  [tooltip]:hover::after,
  [tooltip]:hover::before {
     opacity:1
  }

  [tooltip]:active::after,
  [tooltip]:active::before {
     opacity:1
  }

  /* loading screen */

  .loader {
    position: absolute;
    top: 0;
    bottom: 0;
    right: 0;
    left: 0;
    z-index: 200;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #fff;
    flex-direction: column;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    will-change: opacity;
  }

  .loader.hidden {
    display: none;
  }

  .loader-title {
    will-change: transform;
    font-weight: 400;
  }

  .loader-title strong {
    color: #F0B50C;
  }

  .lds-dual-ring {
    display: inline-block;
    width: 64px;
    height: 64px;
    will-change: transform;
  }

  .lds-dual-ring:after {
    content: " ";
    display: block;
    width: 51px;
    height: 51px;
    margin: 1px;
    border-radius: 50%;
    border: 5px solid #48647c;
    border-color: #48647c transparent #48647c transparent;
    animation: lds-dual-ring 1.2s linear infinite;
  }

  /* Map View/List View picker menu */

  .view-menu {
    text-align: center;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    padding: 0.5em;
    pointer-events: none;
    z-index: 3;
    transition: background-color 0.2s;
  }

  .view-menu.list {
    background-color: #000;
    pointer-events: auto;
  }

  .view-btn {
    pointer-events: auto;
    background: #fff;
    border: 1px solid #ccc;
    padding: 0.5em;
    cursor: pointer;
  }

  .view-btn.active {
    background: #283B62;
    color: #fff;
    text-shadow: -1px -1px #000;
    border: 1px solid #000;
  }

  .view-btn:hover {
    border: 1px solid #000;
    opacity: 0.8;
  }

  .view-btn.active:hover {
    opacity: 1;
  }

  /* Flyout sidebar where marker info is displayed */

  .sidebar {
    position: absolute;
    right: 1em;
    top: 1em;
    width: 45%;
    min-width: 12em;
    transform: translateX(0);
    transition: transform 0.25s ease-in-out;
    z-index: 200;
  }

  .sidebar.hidden {
    transform: translateX(200%);
  }

  .sidebar .content {
    overflow-y: auto;
    height: 100%;
    max-height: 90vh;
    border-top: 4px solid #617482;
    position: relative;
    background: #fff;
    padding: 1em;
    pointer-events: auto;
    opacity: 1;
    word-wrap: break-word;
    box-shadow: 0px 1px 3px #00000069;
    transition: height 0.3s ease-in-out,
                max-height 0.3s ease-in-out;;
  }

  .sidebar .minimized {
    height: 2.7em;
    max-height: 2.7em;
    transition: height 0.3s ease-in-out,
                max-height 0.3s ease-in-out;;
  }

  .sidebar label {
    font-weight: 600;
  }

  .sidebar .title {
    padding-bottom: 0.5em;
    border-bottom: 1px solid #ccc;
  }

  .sidebar .status {
    border-bottom: 1px solid #ccc;
    padding-bottom: 1.1em;
    text-align: center;
    display: flex;
    justify-content: space-between;
  }

  .sidebar .status-tag {
    background: #000;
    padding: 0.3em 0.7em;
    color: #fff;
    margin-right: 0.5em;
    display: inline-block;
  }

  .sidebar .status-detail {
    margin-right: 0.5em;
    max-width: 60%;
  }

  .sidebar .status-explain {
    font-size: 0.8em;
    font-style: italic;
    position: relative;
  }

  .sidebar .address {
    display: inline-block;
    font-style: italic;
    margin: 0 0.5em 0 0;
    margin-right: 0.5em;
  }

  .sidebar .locate {
    font-size: 0.9em;
    background-color: #fff;
    color: #666;
    border: 1px solid #ccc;
    padding: 0.2em 0.5em;
    margin: 0.2em 0;
    cursor: pointer;
  }

  .sidebar .locate:hover {
    color: #000;
    border-color: #000;
  }

  .sidebar .action-btn {
    display: inline-block;
    padding: 0.35em 1.2em;
    border: 2px solid #1995a6;
    border-radius: 1px;
    text-decoration: none;
    margin: 0 0.4em 0.5em 0;
    background-color: transparent;
    color: #1995a6;
    text-align: center;
    transition: background-color 0.2s, color 0.2s;
  }

  .sidebar .action-btn:hover {
    color: #fff;
    background-color: #1995a6;
  }

  .sidebar .controls {
    position: absolute;
    right: 0;
    padding: 0.5em;
    top: 0;
    font-size: 1em;
  }

  .sidebar .close-btn,
  .sidebar .minimize-btn {
    color: #666;
    border: 0;
    cursor: pointer;
    background-color: transparent;
  }

  .sidebar .close-btn:hover {
    color: #27718e;
  }

  .sidebar .minimize-btn:hover {
    color: #27718e;
  }

  /* map legend */

  .legend {
    position: absolute;
    right: 0.5em;
    bottom: 0.5em;
    background: #ffffffad;
    z-index: 2;
    padding: 0.75rem 1em;
    transition: opacity 0.2s ease-in-out;
    box-shadow: 1px 1px 3px #00000069;
  }

  .legend ul {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .legend span {
    width: 1em;
    height: 1em;
    display: inline-block;
    border-radius: 999px;
    margin-right: 0.5em;
  }

  .legend-title {
    margin: 0 0 0.5em;
    font-style: italic;
    font-weight: normal;
  }

  .legend .legend-icon {
    grid-auto-flow: column;
    align-items: center;
    justify-content: start;
    display: grid;
    font-weight: bold;
  }

  .legend .legend-last-row {
    margin-bottom: 0.5rem;
  }

  .legend .icon-marker {
    background: url("data:image/svg+xml,%3Csvg id='Layer_1' data-name='Layer 1' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 23.8 29.8'%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:none;stroke:%23555;stroke-linecap:round;stroke-miterlimit:10;stroke-width:2px;%7D%3C/style%3E%3C/defs%3E%3Cpath class='cls-1' d='M5.1,15.4a10,10,0,0,1-1-4.2C4.2,5.7,9.1,1.1,15,1.1S25.9,5.7,25.9,11.2a10,10,0,0,1-1,4.2' transform='translate(-3.1 -0.1)'/%3E%3Cline class='cls-1' x1='12' y1='28.8' x2='12' y2='28.8'/%3E%3Cpath class='cls-1' d='M5.1,15.4C7,19.5,13.4,25.9,15,28.9' transform='translate(-3.1 -0.1)'/%3E%3Cpath class='cls-1' d='M24.9,15.4C23,19.5,16.6,25.9,15,28.9h0' transform='translate(-3.1 -0.1)'/%3E%3C/svg%3E") no-repeat  center/contain;
  }

  .legend .icon-star {
    background: url("data:image/svg+xml,%3Csvg id='Layer_1' data-name='Layer 1' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30.06 28.58'%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:none;stroke:%23555655;stroke-miterlimit:10;stroke-width:2px;%7D%3C/style%3E%3C/defs%3E%3Cpolygon class='cls-1' points='15.03 2.26 19.01 10.32 27.91 11.62 21.47 17.89 22.99 26.76 15.03 22.57 7.07 26.76 8.59 17.89 2.15 11.62 11.05 10.32 15.03 2.26'/%3E%3C/svg%3E") no-repeat  center/contain;
  }

  /* Branding Attribution */

  .branding {
    position: absolute;
    z-index: 1;
    bottom: 0.5em;
    left: 0.5em;
  }

  /* List View */

  .list-view {
    z-index: 2;
    position: absolute;
    overflow-y: auto;
    bottom: 0;
    /* equal to the height of the view menu bar background */
    top: 3.25em;
    width: 100%;
    transform: translateX(-110%);
    will-change: transform;
    transition: transform 0.2s ease, filter 0.2s ease;
  }

  .list-header {
  }

  .list-view.active {
    background: #fff;
    transform: translateX(0);
  }

  .list-content {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .list-content li {
    display: grid;
    justify-content: left;
    align-items: center;
    grid-auto-flow: column;
    background: #fff;
    padding: 1em;
    border-bottom: 1px solid #ccc;
    cursor: pointer;
  }

  .list-content .active,
  .list-content .active:hover {
    background: #b4dee4;
  }

  .list-content li:hover {
    background: #ddd;
  }

  .ListItemTag {
    display: inline-grid;
    width: fit-content;
    margin-right: 1rem;
  }

  .list-item-type {
    text-transform: uppercase;
    font-size: small;
    text-align: center;
    font-weight: bold;
    background: #000000;
    line-height: 1.9;
    color: #eee;
  }

  .list-content .status {
    background: #000;
    padding: 0.3em 0.7em;
    color: #fff;
  }

  .list-content .title {
    display: inline-block;
    margin-right: 1em;
  }

  .list-content .address {
    font-style: italic;
    margin: 0;
    display: inline-block;
  }

  /* hover marker */

  .marker {
    cursor: pointer;
    /* prevent mouseout event trigger of feature */
    pointer-events: none;
    will-change: opacity;
    animation: fadeInOut ease 2s infinite;
    -webkit-animation: fadeInOut ease 2s infinite;
  }

  /* hover popup */

  .popup-title {
    margin: 0;
  }

  .popup-developer-name {
    margin: 0;
    font-style: italic;
  }

  .popup-type {
    margin: 0;
  }

  /* animation / effects */

  .darken {
    -webkit-filter: brightness(0.8);
    filter: brightness(0.8);
  }

  .transparent {
    opacity: 0.5;
  }

  .fade-in {
    animation: fadeIn ease 0.2s;
    -webkit-animation: fadeIn ease 0.2s;
  }

  .fade-out {
    animation: fadeOut ease 0.2s;
    -webkit-animation: fadeOut ease 0.2s;
  }

  .fade-out-slow {
    animation: fadeOut ease 1s;
    -webkit-animation: fadeOut ease 1s;
  }

  .fade-in-out {
    animation: fadeInOut ease 2s infinite;
    -webkit-animation: fadeInOut ease 2s infinite;
  }

  .slide-out-top {
    animation: slideOutTop ease 1s;
    -webkit-animation: slideOutTop ease 1s;
  }

  .slide-out-bottom {
    animation: slideOutBottom ease 1s;
    -webkit-animation: slideOutBottom ease 1s;
  }

  @keyframes slideOutTop{
    0% {
      transform: translateY(0);
    }
    100% {
      transform: translateY(-100vh);
    }
  }

  @keyframes slideOutBottom{
    0% {
      transform: translateY(0);
    }
    100% {
      transform: translateY(100vh);
    }
  }

  @keyframes lds-dual-ring {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  @keyframes fadeIn{
    0% {
      opacity:0;
    }
    100% {
      opacity:1;
    }
  }

  @-webkit-keyframes fadeIn {
    0% {
      opacity:0;
    }
    100% {
      opacity:1;
    }
  }

  @keyframes fadeOut{
    0% {
      opacity:1;
    }
    100% {
      opacity:0;
    }
  }

  @-webkit-keyframes fadeOut {
    0% {
      opacity:1;
    }
    100% {
      opacity:0;
    }
  }

  @keyframes fadeInOut{
    0% {
      opacity:1;
    }
    50% {
      opacity: 0;
    }
    100% {
      opacity:1;
    }
  }

  @-webkit-keyframes fadeInOut {
    0% {
      opacity:1;
    }
    50% {
      opacity: 0;
    }
    100% {
      opacity:1;
    }
  }

  /* Responsive Styles */

  /* tablet/small screens */
  @media screen and (max-width: 1200px) {

  }
  /* mobile */
  @media screen and (max-width: 768px) {
    .sidebar {
      width: 100%;
      left: 0;
      right: 0;
      top: 0;
    }

    .sidebar .content {
      max-height: 100vh;
    }

    .sidebar .close-btn {
      font-size: 1.1em;
    }
  }
  </style>

  <script>
    // place to stash early sent data for use in the app
    window._publicState = {
      message: ''
    }
    // message listener declared early as possible due to timing of parent message
    window.onmessage = function(e){
      const {data = '', origin = ''} = e;
        // prevent messages from other domains for security
        // if (!CONSTANTS.authorized_parent_domains.includes(origin)) {
        //   return
        // }

        if (data) {        
            window._publicState.message = data; 
        }
    };
  </script>

  <meta name="theme-color" content="#fafafa">
</head>

<body>
  <!--[if IE]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->

  <!-- Add your site or application content here -->
  <section class="loader">
    <h3 class="loader-title">Catalyze <strong>SV</strong></h3>
    <div class="lds-dual-ring"></div>
    <p class="fade-in-out">
      Loading
    </p>
  </section>
  <main id="map"></main>

  <nav class="view-menu"></nav>
  <article class="sidebar hidden">
    <div class="content">
      <div class="controls">
        <button class="minimize-btn">[ - ]</button>
        <button class="close-btn">CLOSE [ X ]</button>
      </div>
      <div class="info fade-in"></div>
    </div>
  </article>
  <aside class="legend">
  </aside>
  <section class="branding"></section>
  <section id="list" class="list-view">
    <div class="list-header"></div>
  </section>

  <script>
    // Avoid `console` errors in browsers that lack a console.
    (function(){var e;var d=function(){};var b=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeline","timelineEnd","timeStamp","trace","warn"];var c=b.length;var a=(window.console=window.console||{});while(c--){e=b[c];if(!a[e]){a[e]=d}}}());
  </script>

  <script>
    //
    // CONSTANTS & STATE
    //
    const state = {
      sidebar_open: false,
      sidebar_min: false,
      tabs: {},
      popups: [],
      listings: {},
      active_tab: null,
      active_project: null,
      active_view: null,
      active_marker: null,
      preset_marker_name: '', 
    }

    const CONSTANTS = {
      authorized_parent_domains: ['https://www.catalyzesv.org', "https://editor.wix.com/"],
      mapbox_key: 'pk.eyJ1IjoiY2F0YWx5emVzdiIsImEiOiJjazZ4d2RoN2gwa2QyM2tydnF6dG1zbjNrIn0.erXugBYot80KgmE2egMXCA',
      mapbox_style_url: 'mapbox://styles/catalyzesv/ck85b2nvx09ba1ipcl1itwh9r',
      css: {
        map: 'map',
        hidden: 'hidden',
        transparent: 'transparent',
        fade: 'fade-in',
        fade_out: 'fade-out',
        fade_out_slow: 'fade-out-slow',
        slide_top: 'slide-out-top',
        slide_bottom: 'slide-out-bottom',
        darken: 'darken',
        active: 'active',
        list: 'list',
        locate_btn: 'locate',
        marker: 'marker',
        minimized: 'minimized'
      },
      offsets: {
        popup: [0,-15],
        marker: [0,-14],
        marker_workshop: [0, 0],
      },
      layers: {
        projects: 'projects-catalyze-sv',
        projects_source: 'Projects_Catalyze_SV',
        dev_zones: 'dev-zones-catalyze-sv',
        dev_zones_source: 'Dev_Zones_Catalyze_SV',
        workshops: 'community-workshops',
        workshops_source: 'Community_Workshops',
      },
      marker_size: '18px',
      marker_svg: "%3Csvg xmlns='http://www.w3.org/2000/svg' width='auto' height='auto' viewBox='0 0 100 100' xml:space='preserve'%3E%3Cpath opacity='0.8' fill='%23fff' d='M91.532,39.844c-0.278-0.804-1.036-1.343-1.888-1.343H61.482l-9.597-27.159c-0.284-0.799-1.039-1.334-1.886-1.334 c-0.846,0-1.602,0.534-1.885,1.334l-9.598,27.159H10.357c-0.851,0-1.609,0.539-1.891,1.343c-0.278,0.804-0.018,1.698,0.651,2.226 l21.986,17.409l-9.84,27.846c-0.281,0.795-0.031,1.682,0.62,2.215c0.654,0.536,1.573,0.603,2.297,0.167l25.818-15.488l25.818,15.488 c0.317,0.191,0.677,0.285,1.032,0.285c0.447,0,0.898-0.152,1.266-0.452c0.651-0.533,0.901-1.42,0.62-2.215l-9.84-27.846 l21.992-17.409C91.553,41.542,91.813,40.648,91.532,39.844z'/%3E%3C/svg%3E",
      projects_id_key: 'Project Name',
      workshops_id_key: 'Project Name',
      webpage_key: 'Website Page',
      status_tip: 'Projects go through several phases. Developers submit applications to the City, get their design reviewed, do redesigns based on City & community feedback,  resubmit proposals for review, and get approval (though can even redesign after approval)',
      catalyze_logo_img: 'https://static.wixstatic.com/media/f632f7_4b161d28a60f4906aea2a55c528ce323~mv2.png/v1/fill/w_151,h_16/catalyzelogo.png',
      max_icon: '+',
      min_icon: '-'
    }
    const data = {
      features: [],
      features_map: {},
      feature_types: {
        project: 'project',
        workshop: 'workshop'
      },
      // phase names and their associated colors
      phases: {
        'Withdrawn': '#989898',
        'In Design': '#86619f',
        'In Review': '#268adb',
        'Approved': '#358c29',
        'Construction': '#aa8f00'
      },
      // the order to output the legend items in
      legend_order: [
        'Withdrawn',
        'In Design',
        'In Review',
        'Approved',
        'Construction'
      ],
      // view types in the view menu
      view_types: [{
          name: 'List View',
          id: 'list'
        }, {
          name: 'Map View',
          id: 'map'
      }]
    }

    // dom elements references
    const map_element = document.querySelector('#map');
    const sidebar = document.querySelector('.sidebar');
    const sidebar_content = document.querySelector('.sidebar .content');
    const sidebar_info = document.querySelector('.info');
    const close_btn = document.querySelector('.close-btn');
    const min_btn = document.querySelector('.minimize-btn');
    const legend = document.querySelector('.legend');
    const branding = document.querySelector('.branding');
    const list_view = document.querySelector('.list-view');
    const view_menu = document.querySelector('.view-menu');
    const loader = document.querySelector('.loader');
    const loader_text = document.querySelector('.loader p');
    const loader_title = document.querySelector('.loader .loader-title');

    //
    // Utilities
    //

    function format_to_only_letters_numbers(text = '') {
      /*
      Replaces any non-letter or number character like punctuation or spaces
      in a string with empty.
      Args: text (str) - the text to reformat
      Return: reformatted text (str) - the string with all the extra stuff stripped out
      */
     const matchingExclusions = /[^A-Za-z0-9]+/gm;
     return text.replaceAll(matchingExclusions, '');
    }

    function fuzzy_match_strings(first_text = '', second_text = '') {
      /*
      Check whether 2 text strings match, excluding puncutation, white space, and casing.
      Args: first_text (str) - 1st string to reformat and check
            second_text (str) - 2nd string to reformat and check
      Return: boolean - whether the 2 words match
      */
      const normalized_first_text = format_to_only_letters_numbers(first_text.toLowerCase());
      const normalized_second_text = format_to_only_letters_numbers(second_text.toLowerCase());

      return normalized_first_text === normalized_second_text
    }

    //
    // APP COMPONENTS & FUNCTIONS
    // 

    function toggle_text(text, first_text, second_text) {
      /*
      Acts as a toggle for textual content in an element by grabbing
      the text content of an element, checking if the first text
      exists in the content, replacing just that first text if so
      (leaving other text unchanged) and vice versa.
      Args: text (str) - text to check.
            first_text (str) - first text to toggle between
            second_text (str) - second text to toggle between
      Return: text (str) - changed text
      */
      text.includes(first_text) ?
        text = text.replace(first_text, second_text) :
        text = text.replace(second_text, first_text)

      return text
    }

    function is_valid(input) {
      /*
      Returns truthy or falsey values based on the validation conditions being met.
      If undefined, empty string, or 'na', it'll return falsey.
      Args: input (str, undefined, null) - typically a string with the input text to validate
        but can also be undefined or null if a blank input field
      Return: truthey/falsey (booleanish) - true or one of several falsey values:
        undefined, null, '', false, depending on the value inputted
      */
      // check that input is defined
      return !!(input &&
              // check if na
              input.toLowerCase() !== 'n/a')
    }

    function getUniqueFeatures(array, comparatorProperty) {
      // Because features come from tiled vector data, feature geometries may be split
      // or duplicated across tile boundaries and, as a result, features may appear
      // multiple times in query results.
      const existingFeatureKeys = {};
      const uniqueFeatures = array.filter(function(el) {
        if (existingFeatureKeys[el.properties[comparatorProperty]]) {
          return false;
        } else {
          existingFeatureKeys[el.properties[comparatorProperty]] = true;
          return true;
        }
      });

      return uniqueFeatures;
    }

    function get_bounds_of_source_layer(source_layer_id, feature_key) {
      /*
      Gets a LngLatBounds obj that will encompass all the features in a source
      layer. Source layers contain all features, even outside of the map viewport.
      Function is dependent on source compositing being turned on in Mapbox.
      Args: source_layer_id (str) - the id of the source layer to get features from
            feature_key (str) - the unique key to use in filtering duplicates
      Return: layer_bounds (obj) - a LngLatBounds obj containing 2 coordinates for (var i = 0; i < the sw and ne corners of bounds that will fit all the featuresngth; i++) {
        the sw and ne corners of bounds that will fit all the features
      }
      */
      const layer_bounds = new mapboxgl.LngLatBounds();
      // gets the source info for all features, even outside of current viewport
      const all_features = map.querySourceFeatures('composite', {
        'sourceLayer': source_layer_id
      });
      // filter any duplicates in case of features on tile boundaries
      const unique_features = getUniqueFeatures(all_features, feature_key);

      unique_features.forEach((current_feature) => {
        layer_bounds.extend(current_feature.geometry.coordinates);
      });

      return layer_bounds
    }

    function generate_view_menu_item(view_type, id) {
      /*
      Creates a view menu navigation item to select the view type.
      Args: view_type (str) - the type of view to show for this button
            id (str) - the id of the view to retrieve in the event listener
      Return: btn (obj) - button dom element w/ attributes set
      */
      const btn = document.createElement('button');
      btn.textContent = view_type;
      btn.setAttribute('data-view-id', id);
      btn.classList.add('view-btn');

      return btn;
    }

    function LegendIcon(type = '') {
      /*
      Creates a dom element for an icon in the legend
      Args: type (string) - what type of icon to display
      Return: span dom element for the icon (obj)
      */

      const list_item = document.createElement('li');
      list_item.classList.add('legend-icon');

      // create the legend title
      const icon = document.createElement('span');
      switch(type) {
        case 'marker':
          icon.classList.add('icon-marker');
          list_item.textContent = 'Project';
          break;
        case 'star':
          icon.classList.add('icon-star');
          list_item.textContent = 'Workshop';
          break;
        default: 
          console.log('No icon set for that type', type);
          return null
      }

      list_item.prepend(icon);

      return list_item
    }

    function LegendTitle(text = '', name = '') {
      /*
      Creates a heading dom element for the map legend / key
      Args: text (string) - text to display in the heading element
            name (string) - class name to add to the elements class list
      Return: heading h4 dom element with title (obj)
      */

      const list_item = document.createElement('li');
      // create the legend title
      const title = document.createElement('h4');
      title.classList.add('legend-title');
      title.classList.add(name);
      title.textContent = text;

      list_item.append(title)

      return list_item
    }

    function generate_legend(phases, order) {
      /*
      Creates and populates the dom elements for the map legend / key
      Args: phases (obj) - obj containing name/color info for each label
            order (array) - array of keys = phases showing order to output
      Return: legend ul dom element (obj)
      */
      const legend_list = document.createElement('ul');

      const marker_icon = LegendIcon('marker');
      const workshop_icon = LegendIcon('star');
      workshop_icon.classList.add('legend-last-row');

      legend_list.append(marker_icon, workshop_icon);

      // create the legend title
      const city_status_title = LegendTitle('Status With City', 'city-status');

      legend_list.append(city_status_title);

      order.forEach((current_item) => {
        // create labels and key colors per legend item
        let item_color = document.createElement('span');
        item_color.style.backgroundColor = phases[current_item];
        let list_item = document.createElement('li');
        list_item.textContent = current_item;

        // so the color appears first
        list_item.prepend(item_color);
        legend_list.append(list_item);
      });

      return legend_list
    }

    function ProjectInfo(marker_properties = {}) {
      /*
      Creates the sidebar info element dom contents for a project item.
      Args: marker_properties (obj) - contains the properties for a given marker
            feature_type (str) - if its a project or workshop so we use different templates
      Return: template string literal (str) - html string to set the info template element to
      */
      let { Address,
             City,
             State,
             Phase,
             "Project Name" : project_name,
             "ZIP Code": Zip,
             "Type of Project/ Overview" : project_type,
             "Link to City Documents" : city_docs,
             "Date Presented to PAC" : presented_date,
             "Current Status in Catalyze SV" : catalyze_status,
             "Next Public Meeting" : next_meet,
             "Project Website" : website,
             "Owner/Developer Name" : developer,
             "Current Status With City" : phase_detail,
             "Catalyze SV's Scorecard" : score,
             "Catalyze SV's Letter" : catalyze_letter,
             "Catalyze SV's Initial Letter" : catalyze_initial_letter,
             "Community Partners" : partners,
           } = marker_properties;

      // show/hide some info dependent on if it is available in dataset
      const catalyze_letter_html = is_valid(catalyze_letter)
          ? `<a href=${catalyze_letter} class="action-btn" target="_blank" rel="noreferrer">Read Catalyze SV's Letter</a>`
          : '';
      const catalyze_initial_letter_html = is_valid(catalyze_initial_letter)
          ? `<a href=${catalyze_initial_letter} class="action-btn" target="_blank" rel="noreferrer">Read Catalyze SV's Initial Letter</a>`
          : '';
      const catalyze_scorecard_html = is_valid(score)
          ? `<a href=${score} class="action-btn" target="_blank" rel="noreferrer">See Catalyze SV Scorecard</a>`
          : '';
      const website_html = is_valid(website)
          ? `<a href=${website} class="action-btn" target="_blank" rel="noreferrer">View Project Website</a>`
          : '';
      const presented_date_html = is_valid(presented_date)
          ? `<li><label>Presented to PAC on:</label> ${presented_date}</li>`
          : '';
      const catalyze_status_html = is_valid(catalyze_status)
          ? `<p><label>Catalyze SV Review Status:</label> ${catalyze_status}</p>`
          : '';
      const next_meet_html = is_valid(next_meet)
          ? `<li><label>Next Public Meeting:</label> ${next_meet}</li>`
          : `<li><label>Next Public Meeting:</label> TBD</li>`;
      const city_docs_html = is_valid(city_docs)
          ? `<a href=${city_docs} class="action-btn" target="_blank" rel="noreferrer">View City Documents</a>`
          : '';
      const partners_html = is_valid(partners)
            ? `<a href=${partners} class="action-btn" target="_blank" rel="noreferrer">Community Partners</a>`
            : '';
      const phase_color = data.phases[Phase];
      const tooltip = CONSTANTS.status_tip

      // template for the sidebar content
      return `
        <h2 class="title">${project_name}</h3>
        <p class="status">
          <span>
            <span class="status-tag" style="background:${phase_color}">${Phase}</span>
          </span>
          <span class="status-detail">${phase_detail}</span>
          <span>
            <a href="#" class="status-explain" tooltip="${tooltip}">What's This?</a>
          </span>
        </p>
        <p class="address">
          ${Address}, ${City}, ${State} ${Zip}
        </p>
        <button class="locate">&#9733; Center on Map</button>
        <p>
          ${project_type}
        </p>
        <ul>
          <li>
            <label>Owner/Developer:</label> ${developer}
          </li>
          ${presented_date_html}
          ${next_meet_html}
        </ul>
        <hr />
        <h3>Resources & Links</h4>
        ${catalyze_status_html}
        <p>
          Catalyze SV evaluates project sustainability, equity, and vibrancy. <a href="https://www.catalyzesv.org/projects">Learn about our project review process.</a>
        </p>
        <p>
          ${catalyze_scorecard_html}
          ${catalyze_letter_html}
          ${catalyze_initial_letter_html}
          ${city_docs_html}
          ${website_html}
          ${partners_html}
        </p>`
    }

    function WorkshopInfo(marker_properties = {}) {
      /*
      Creates the sidebar info element dom contents for a workshop item.
      Args: marker_properties (obj) - contains the properties for a given marker
            feature_type (str) - if its a project or workshop so we use different templates
      Return: template string literal (str) - html string to set the info template element to
      */
      let { Address,
             City,
             State,
             Phase,
             "Project Name" : project_name,
             "ZIP Code": Zip,
             "Type of Project/ Overview" : project_type,
             "Link to City Documents" : city_docs,
             "Community Meeting Type" : meeting_type,
             "Community Meeting Date" : meet_date,
             "Project Website" : website,
             "Owner/Developer Name" : developer,
             "Type of Project/Overview" : type_of_project,
             "Current Status With City" : phase_detail,
             "Community Workshop Recap" : recap,
             "Video Link" : video,
             "Video Link 2" : video2,
             "Next Public Meeting": next_meet,
             "Community Partners" : partners,
           } = marker_properties;

           // show/hide some info dependent on if it is available in dataset
           const video_html = is_valid(video)
               ? `<a href=${video} class="action-btn" target="_blank" rel="noreferrer">Watch Video</a>`
               : '';
           const video_2_html = is_valid(video2)
               ? `<a href=${video2} class="action-btn" target="_blank" rel="noreferrer">Watch Additional Video</a>`
               : '';
           const recap_html = is_valid(recap)
               ? `<a href=${recap} class="action-btn" target="_blank" rel="noreferrer">Read Workshop Recap</a>`
               : '';
           const website_html = is_valid(website)
               ? `<a href=${website} class="action-btn" target="_blank" rel="noreferrer">View Project Website</a>`
               : '';
           const meeting_date_html = is_valid(meet_date)
               ? `<li><label>Community Meeting Date:</label> ${meet_date}</li>`
               : '';
           const meeting_type_html = is_valid(meeting_type)
               ? `<p><label>Community Meeting Type:</label> ${meeting_type}</p>`
               : '';
           const next_meet_html = is_valid(next_meet)
               ? `<li><label>Next Public Meeting:</label> ${next_meet}</li>`
               : `<li><label>Next Public Meeting:</label> TBD</li>`;
           const city_docs_html = is_valid(city_docs)
               ? `<a href=${city_docs} class="action-btn" target="_blank" rel="noreferrer">View City Documents</a>`
               : '';
           const partners_html = is_valid(partners)
               ? `<a href=${partners} class="action-btn" target="_blank" rel="noreferrer">Community Partners</a>`
               : '';
           const phase_color = data.phases[Phase];
           const tooltip = CONSTANTS.status_tip;
           const project_type_content = project_type ? project_type : "";

           // template for the sidebar content
           return `
             <h2 class="title">${project_name}</h3>
             <p class="status">
               <span>
                 <span class="status-tag" style="background:${phase_color}">${Phase}</span>
               </span>
               <span class="status-detail">${phase_detail}</span>
               <span>
                 <a href="#" class="status-explain" tooltip="${tooltip}">What's This?</a>
               </span>
             </p>
             <p class="address">
               ${Address}, ${City}, ${State} ${Zip}
             </p>
             <button class="locate">&#9733; Center on Map</button>
             <p>
               ${project_type_content}
             </p>
             <ul>
               <li>
                 <label>Owner/Developer:</label> ${developer}
               </li>
               ${meeting_date_html}
               ${next_meet_html}
             </ul>
             <hr />
             <h3>Resources & Links</h4>
             ${meeting_type_html}
             <p>
              Catalyze SV works with cities and developers to enhance the community engagement process. <a href=" https://www.catalyzesv.org/communityengagement">Learn about our community engagement work.</a>
             </p>
             <p>
               ${city_docs_html}
               ${website_html}
               ${partners_html}
               ${video_html}
               ${video_2_html}
               ${recap_html}
             </p>`
    }

    function generate_sidebar(marker_properties = {}, layer_type ='') {
      /*
      Creates the sidebar info element dom contents for a project item.
      Args: marker_properties (obj) - contains the properties for a given marker
            feature_type (str) - if its a project or workshop so we use different templates
      Return: template string literal (str) - html string to set the info template element to
      */
      switch (layer_type) {
        case CONSTANTS.layers.projects:
          return ProjectInfo(marker_properties)
        case CONSTANTS.layers.workshops:
          return WorkshopInfo(marker_properties)
        default:
          console.log('No template to use for this layer type', layer_type);
      }

    }

    function ListItemTag(item = {}, phases = {}) {
      /*
      Component to create tag/badge part of a list item in the list view, the left most
      part that shows the status.
      Args: item (obj) - the feature information for the current item
            phases (obj) - table of the phases and their colors
      Return: list item tag (obj) - dom element containing the list item tag
      */
      const { 
        layer : { id = '' }, 
        properties : { Phase = '' },
      } = item;

      const tag_container = document.createElement('span');
      tag_container.classList.add('ListItemTag');
      // shows the high level what type of item it is i.e project or workshop
      const item_type = document.createElement('span');
      item_type.classList.add('list-item-type');
      // show certain titles for each layer type
      switch (id) {
        case CONSTANTS.layers.projects:
          item_type.textContent = 'Project';
          break;
        case CONSTANTS.layers.workshops:
          item_type.textContent = 'Workshop';
          break;
        default:
          console.log('No text content defined for that layer id', id)
      }

      const status_tag = document.createElement('span');
      status_tag.textContent = Phase;
      status_tag.classList.add('status');
      // recolor according to phase
      status_tag.style.backgroundColor = phases[Phase];

      tag_container.append(item_type, status_tag);

      return tag_container
    }

    function generate_list_view(map_features, phases) {
      /*
      Generates the ul dom element containing the list view of the projects on the
      map based on the map feature array passed in.
      Args: map_features (arr) - array of layer map geojson features from a mapbox layer
            phases (obj) - obj containing color data for each phase
      Return: list (obj) - ul dom element of the list view items
      */
      const list = document.createElement('ul');
      list.classList.add('list-content');

      map_features.forEach((current_item, i) => {
        const current_props = current_item.properties;
        const { layer : { id } } = current_item;
        const { Phase, Address, "Project Name" : project_name } = current_props;
        const isProject = id === CONSTANTS.layers.projects;
        const isWorkshop = id === CONSTANTS.layers.workshops;

        let current_feature = document.createElement('li');
        // store the name to know which marker's info to retrieve
        current_feature.setAttribute('data-name', project_name);
        current_feature.setAttribute('data-index', i);

        const list_item_tag = ListItemTag(current_item, phases);

        let title = document.createElement('h3');
        title.textContent = project_name;
        title.classList.add('title');

        let address = document.createElement('p');
        address.textContent = Address;
        address.classList.add('address');
        current_feature.append(list_item_tag, title, address);

        state.listings[project_name] = current_feature;

        list.append(current_feature)
      });

      return list;
    }

    function Popup(props) {
      /*
      Renders the popup html elements for a popup to show.
      Args: props (obj) - properties needed to render correctly, needs the current project
      Return: str - html string
      */
      const { 
        current_project: { 
          properties = {}
        },
        show_cta = true,
      } = props;
    
      const {
        'Project Name': name = '',
        'Owner/Developer Name': developer = '',
        'Type of Project/ Overview': type = '',
      } = properties;

      const call_to_action = show_cta ? '<strong>Click Marker to Open Full Info</strong>' : '';
      
      return (`
        <h4 class="popup-title">
          ${name}
        </h4>
        <p class="popup-developer-name">
          By ${developer}
        </p>
        <p class="popup-type">
          ${type}
        </p>
        ${call_to_action}
      `)
    }

    function make_name_popup(current_project, show_cta = true) {
      /*
      Show the given popup on the map using info from a project.
      Args: current_project (obj) - a specific map feature element w/ geometry and properties,
            typically returned from an event listener -> event.features[0]
            show_cta (bool) - whether to show the cta in the popup
      Return: Popup (obj) - instance containing the coordinates and text for the marker
      */
      // need to instantiate a new Popup otherwise the mousover popups won't
      // allow the click triggered one to show and it'll interfere with animations
      const popup = new mapboxgl.Popup({
        closeButton: false,
        className: CONSTANTS.css.fade,
        offset: CONSTANTS.offsets.popup
      });

      popup.setLngLat(current_project.geometry.coordinates)
        .setHTML(Popup({current_project, show_cta}))

      return popup
    }

    function make_active_marker(svg_img, size, CONSTANTS) {
      /*
      Create a DOM element for the marker used as the overlay for the
      hover/active feature highlightin effect.
      Args: svg_img (str) - uri encoded svg img xml
            size (str) - valid size for css width/height
            CONSTANTS (obj) - to fill in all the constants values
      Return: marker (obj) - marker instance to use for active marker
      */
      // css bg img data uri encoded bg img
      const star_svg_encoded = `url("data:image/svg+xml,${svg_img}")`

      const marker = document.createElement('div');
      marker.className = CONSTANTS.css.marker;
      // set all the marker css style props
      Object.assign(marker.style, {
        backgroundImage: star_svg_encoded,
        width: size,
        height: size
      });

      return new mapboxgl.Marker(marker, {
        offset: CONSTANTS.offsets.marker
      });
    }

    function play_sidebar_animation(sidebar_open) {
      /*
      Plays the corresponding sidebar animation for the sidebar dom element
      depending on if the sidebar is already open or not.
      Args: sidebar_open (bool) - whether the sidebar is open or not
      Return: na
      */
      // animate sidebar info change if sidebar already open
      if (sidebar_open) {
        // block applied css animation with an override
        sidebar_info.style.animation ='none';
        // trigger reflow so css animation can play again
        void sidebar_info.offsetWidth;
        // allow defined css animation to play again
        sidebar_info.style.animation = null;
      } else {
        // otherwise just show the sidebar
        state.sidebar_open = true;
        sidebar.classList.toggle(CONSTANTS.css.hidden);
        legend.classList.toggle(CONSTANTS.css.transparent);
        state.active_view.classList.toggle(CONSTANTS.css.darken);
      }
    }

    function show_sidebar(feature) {
      /*
      Shows the sidebar and the info in it for the currently selected feature/marker.
      Args: feature (obj) - the feature obj for the project to display info for w/ a properties obj
      Return: na
      */
      const { layer:{ id } } = feature;

      // clear existing content by looping through sidebar info children
      while (sidebar_info.firstChild) {
          sidebar_info.firstChild.remove();
      }

      // animate sidebar changes according to if the sidebar is already open
      play_sidebar_animation(state.sidebar_open);

      // sidebar elements container that can be innerHTML'ed
      const info_template = document.createElement('template');
      info_template.innerHTML = generate_sidebar(feature.properties, id);
      // makes the template element active so its visible in the dom
      const active_template = info_template.content.cloneNode(true);
      sidebar_info.append(active_template);
      // match border color with legend/icon colors for phases
      sidebar_content.style.borderColor = data.phases[feature.properties['Phase']];

      // maximize sidebar content if minimized
      if (state.sidebar_min) {
        toggle_sidebar_minimize({
          sidebar_content: sidebar_content,
          min_btn: min_btn
        }, state, CONSTANTS);
      }
    }

    function toggle_sidebar_minimize(elements, state, CONSTANTS) {
      /*
      Toggles the sidebar minimized state animation and button
      content change.
      Args: elements (obj) - contains sidebar_content dom node and the min_btn dom node for the minimize button
            state (obj) - state for the app
            CONSTANTS (obj) - constants for the app
      Return: na
      */
      const {sidebar_content, min_btn} = elements;

      // minimize the sidebar content
      sidebar_content.classList.toggle(CONSTANTS.css.minimized);
      // change the minimize btn icon to reflect toggling action
      min_btn.textContent = toggle_text(min_btn.textContent, CONSTANTS.min_icon, CONSTANTS.max_icon)

      state.sidebar_min = !state.sidebar_min;
    }

    function show_view(view_type) {
      /*
      Switches the current view to the specified view and marks the corresponding
      tab as active.
      Args: view_type (str) - which view to show using the ids in the view types array
      Return: na
      */
      // unhighlight current active tab then highlight clicked tab
      state.active_tab.classList.remove(CONSTANTS.css.active);
      state.active_tab = state.tabs[view_type];
      state.active_tab.classList.add(CONSTANTS.css.active);

      // switch view menu styles specific to the active view
      view_menu.classList.remove(state.active_view.id);
      view_menu.classList.add(view_type);

      // hide previous active view and show current active view
      state.active_view.classList.remove(CONSTANTS.css.active, CONSTANTS.css.darken);
      state.active_view = document.getElementById(view_type);
      state.active_view.classList.add(CONSTANTS.css.active)

      // if sidebar is open we need to apply darkening to current view
      if (state.sidebar_open) {
        state.active_view.classList.add(CONSTANTS.css.darken);
      }
    }

    function animate_popup_removal(popup) {
      /*
      Animates the removal of the popup by waiting for the animation to complete
      before removal.
      Args: popup (obj) - popup dom element to be animated/removed
      Return: na
      */
      popup.classList.toggle(CONSTANTS.css.fade_out);

      // named animationend callback so listener can be deleted to prevent memory leaks
      const remove_popup = (e) => {
        popup.removeEventListener('animationend', remove_popup);
        // popup.remove();
        clear_popups(state);
      };

      // only remove popup after css animation completes
      popup.addEventListener('animationend', remove_popup);
    }

    function highlight_active_listing(active_project, current_listing) {
      /*
      Highlights the currently selected project/marker in the list view.
      Args: state (obj) - the state obj containing state.active_project whether it's
              null or the feature obj that is currently active
            current_listing (obj) - the dom element in the list view corresponding
              to the feature to be made active
      Return: na
      */
      // if something's already highlighted, need to remove the highlight first
      if (active_project) {
        active_project.classList.remove(CONSTANTS.css.active)
        current_listing.classList.add(CONSTANTS.css.active);
      } else {
        current_listing.classList.add(CONSTANTS.css.active);
      }
      state.active_project = current_listing;
    }

    function activate_feature(feature_data, state) {
      /*
      Puts a feature into an active state, denoting that it is currently
      being viewed and the details for it will be showing.
      Args: feature_date (obj) - config obj that requires {feature: feature_geojson_obj, listing: listing_dom_element}
            state (obj) - the state object
      Return: na
      */
      const {feature, listing} = feature_data;

      highlight_active_listing(state.active_project, listing);
      show_sidebar(feature);
      // clear extra popups from click event on a point propagating to multiple layers
      clear_popups(state);
      const popup = make_name_popup(feature).addTo(map);
      state.popups.push(popup);

      // show active marker overlaid current feature
      state.active_marker.setLngLat(feature.geometry.coordinates).addTo(map);
    }

    function hoverize_feature(feature, state, show_popup = true) {
      /*
      Puts a feature into a hover state ie styles to hint interactivity
      or release information scent.
      Args: feature (obj) - the feature geojson object to hoverize style
            state (obj) - the state object
            show_popup (bool) - whether to show the poup
      return: na
      */
      const { layer : {id} } = feature;
      const isWorkshop = id === CONSTANTS.layers.workshops;
      if (show_popup) {
        const popup = make_name_popup(feature).addTo(map);
      
        state.popups.push(popup);
      }
      if (isWorkshop) {
        state.active_marker.setOffset(CONSTANTS.offsets.marker_workshop);
      } else {
        state.active_marker.setOffset(CONSTANTS.offsets.marker);
      }
      // show active marker overlaid current feature
      state.active_marker.setLngLat(feature.geometry.coordinates).addTo(map);
    }

    function clear_popups(state) {
      /*
      Remove all popups from the map.
      Args: state (obj) - the state object
      Return: na
      */
      state.popups.forEach(popup => popup.remove());
      state.popups.length = 0;
    };

    function deactivate(state) {
      /*
      Removes active styles and elements for a feature.
      Args: state (obj)
      Return:
      */
      // Change it back to a cursor when it leaves
      map.getCanvas().style.cursor = '';

      // don't want mouseovers to change the opened popup when sidebar is open
      if (!state.sidebar_open) {
        clear_popups(state);
        // hide the active marker overlay
        state.active_marker.remove();

        // map.off('mouseleave', deactivate);
      }
    }

    function getFeatureByProjectName(name = '', features = []) {
      /*
      Given an array of features, find the matching feature with the
      given project name and return it.
      Args: name (str) - project name to match features by
            features (arr) - array of features to search through
      Return: feature (obj) - the feature item matching the project name
      */

      const theMatchingFeature = (current) => {
        const {
          properties : { 'Project Name' : feature_name = '' },
          geometry : { coordinates },
        } = current;

        // match the name and feature name ignoring case, spacing, and punctuation
        return fuzzy_match_strings(name, feature_name)
      }

      return features.find(theMatchingFeature);
    }

    function moveToFeatureByName(name, features) {
      /*
      Moves the map to a specified feature's location on the specified layer by matching 
      the Project Name passed to the one in the dataset. Zooms on that feature.
      Args: name (str) - the Project Name matching the mapbox dataset of the specified feature (case insensitive)
            features (arr) - array of feature objects to find the matching element in
      Return: na
      */
      const featureToMoveTo = getFeatureByProjectName(name, features);

      // if no match, don't do anything
      if (!Object.keys(featureToMoveTo).length) {
        return
      }

      map.jumpTo({
        center: featureToMoveTo.geometry.coordinates,
        zoom: 13
      })
    }

    // =============== APP LOGIC ===============

    // generate the map
    mapboxgl.accessToken = CONSTANTS.mapbox_key;
    const map = new mapboxgl.Map({
      container: 'map',
      style: CONSTANTS.mapbox_style_url,
      center: [-121.898395, 37.322972],
      zoom: 11,
      logoPosition: 'bottom-right'
    });

    // signal to the parent window that we're ready to receive messages
    // if we're an embedded iframe on the specified domain


    // if embedded iframe on the authorized parent, send a ready message to the parent
    CONSTANTS.authorized_parent_domains.forEach((currentDomain) => {
      window.parent.postMessage('ready', currentDomain);
    });


    // wait for map to finish load before executing map functions
    map.on('load', () => {

      // ========= MAP UI / VIEW CREATION ============

      // fit map viewport to all plotted projects
      const projects_bounds = get_bounds_of_source_layer(CONSTANTS.layers.projects_source, CONSTANTS.projects_id_key);

      map.fitBounds(projects_bounds, {
        padding: 100
      });

      // create the view type menu
      const view_contents = document.createDocumentFragment();
      data.view_types.forEach((current_item, i) => {
        let view_btn = generate_view_menu_item(current_item.name, current_item.id);
        // have map view button shown as active by default
        if (i === 1) {
          view_btn.classList.add(CONSTANTS.css.active);
          state.active_tab = view_btn;
          state.active_view = map_element;
        }
        view_contents.append(view_btn);
        // save tabs for later switching use without requerying dom
        state.tabs[current_item.id] = view_btn;
      });
      view_menu.append(view_contents);

      // create the legend element
      const legend_elements = generate_legend(data.phases, data.legend_order);
      legend.append(legend_elements);

      // Add zoom, fullscreen, rotation controls to the map.
      map.addControl(new mapboxgl.NavigationControl());
      map.addControl(new mapboxgl.FullscreenControl({
        container: document.querySelector('body')
      }));

      // create the hover/active marker overlay
      state.active_marker = make_active_marker(CONSTANTS.marker_svg, CONSTANTS.marker_size, CONSTANTS);

      // add catalyze branding
      const brand = document.createElement('img');
      brand.src = CONSTANTS.catalyze_logo_img;
      branding.append(brand);

     

      // create the list view
      map.on('idle', () => {
        // only need to get the features once
        if(!data.features.length) {
          // grab the features on the projects layer
          const rendered_features = map.queryRenderedFeatures({layers: [CONSTANTS.layers.projects]});
          const workshop_rendered_features = map.queryRenderedFeatures({layers: [CONSTANTS.layers.workshops]});
          // filter duplicates by name, save features in original format for later use
          const uniqueProjects = getUniqueFeatures(rendered_features, CONSTANTS.projects_id_key);
          const uniqueWorkshops = getUniqueFeatures(workshop_rendered_features, CONSTANTS.workshops_id_key);
          const allUniqueFeatures = [...uniqueProjects, ...uniqueWorkshops];
          data.features = allUniqueFeatures;
          // create map of features by project name
          data.features_map = data.features.reduce((map, current_item) => {
            map[current_item.properties[CONSTANTS.projects_id_key]] = current_item;
            return map
          }, {});

          const projects_list = generate_list_view(data.features, data.phases);
          list_view.append(projects_list);
        }

        // receive and interpet signals from parent window if need to do stuff for that
        const { message = '' } = window._publicState;
        if (message) {
          const parentMsgData = JSON.parse(message);
          const { presetMarker = '' } = parentMsgData;
          // save the preset marker name id if it was sent from parent
          state.preset_marker_name = presetMarker;
          // clear the message data
          window._publicState.message = '';
        }
        
        // if preset marker is set, center+zoom the map on that feature
        if (state.preset_marker_name) {
          // move to a specified set point if signaled in the state or by postmessage
          const project_features = map.querySourceFeatures('composite', {
            'sourceLayer': CONSTANTS.layers.projects_source
          });
          const workshop_features = map.querySourceFeatures('composite', {
            'sourceLayer': CONSTANTS.layers.workshops_source
          });
          const all_source_features = [...project_features, ...workshop_features];

          moveToFeatureByName(state.preset_marker_name, all_source_features);

          const presetFeature = getFeatureByProjectName(state.preset_marker_name, data.features);
          hoverize_feature(presetFeature, state, false);
        }
      });

      map.once('idle', ()=> {
        // wait for map idle to remove preloader as that is when everything has rendered
        // and map logic has run, including any lazy loaded in source data chunks

        // ============ PRELOADER =============

        // animate hiding loader on map load
        loader.classList.add(CONSTANTS.css.fade_out_slow);
        loader_title.classList.add(CONSTANTS.css.slide_top);
        loader_text.classList.add(CONSTANTS.css.slide_bottom);

        // named animationend callback so listener can be deleted to prevent memory leaks
        const hide_loader = (e) => {
          loader.removeEventListener('animationend', hide_loader);
          loader.classList.add(CONSTANTS.css.hidden);
        };

        // hide loader after css animation completes
        loader.addEventListener('animationend', hide_loader);

        // clear preset marker so it doesnt keep centering on it every idle
        state.preset_marker_name = ''
      });

      // ======= CONTROLS & INTERACTION ========

      // catch the target through event bubbling
      view_menu.addEventListener('click', (e) => {
        const view_type = e.target.getAttribute('data-view-id');

        show_view(view_type);
      });

      list_view.addEventListener('click', (e) => {
        const current_listing = e.target.closest('li');
        const current_project_id = current_listing.getAttribute('data-index');
        const current_feature = data.features[current_project_id];
        const current_page = current_feature.properties[CONSTANTS.webpage_key];

        // activate_feature({
        //   feature: data.features[current_project_id],
        //   listing: current_listing
        // }, state);

        window.open(current_page, '_blank');
      });

      // When a click event occurs on a marker in the projects layer, show info
      map.on('click', CONSTANTS.layers.projects, (e) => {


        const current_project = e.features[0];
        const current_project_name = current_project.properties[CONSTANTS.projects_id_key];
        const current_project_page = current_project.properties[CONSTANTS.webpage_key];

        window.open(current_project_page, '_blank');

        // activate_feature({
        //   feature: current_project,
        //   listing: state.listings[current_project_name]
        // }, state);
      });

      // add an event handler for clicks on workshops
      map.on('click', CONSTANTS.layers.workshops, (e) => {

        const current_workshop = e.features[0];
        const current_workshop_name = current_workshop.properties[CONSTANTS.projects_id_key];
        const current_workshop_page = current_workshop.properties[CONSTANTS.webpage_key];

        // activate_feature({
        //   feature: current_workshop,
        //   listing: state.listings[current_workshop_name]
        // }, state);
        window.open(current_workshop_page, '_blank');
      });      

      // handle clicks on dev zone areas
      // map.on('click', CONSTANTS.layers.dev_zones, (e) => {
      //   const current_project_name = e.features[0].properties[CONSTANTS.projects_id_key];

      //   activate_feature({
      //     feature: data.features_map[current_project_name],
      //     listing: state.listings[current_project_name]
      //   }, state);
      // });

      close_btn.addEventListener('click', () => {

        // hide the sidebar on click
        state.sidebar_open = false;
        sidebar.classList.toggle(CONSTANTS.css.hidden);
        // remove deemphasizing styles
        legend.classList.toggle(CONSTANTS.css.transparent);
        state.active_view.classList.remove(CONSTANTS.css.darken);
        // clear active in list
        state.active_project.classList.remove(CONSTANTS.css.active)
        state.active_project = null;

        // remove current popup element after animation ends
        animate_popup_removal(state.popups[0].getElement());

        // maximize sidebar content if minimized
        if (state.sidebar_min) {
          toggle_sidebar_minimize({
            sidebar_content: sidebar_content,
            min_btn: min_btn
          }, state, CONSTANTS);
        }

        // hide the active marker overlay
        state.active_marker.remove();
      });

      min_btn.addEventListener('click', () => {

        toggle_sidebar_minimize({
          sidebar_content: sidebar_content,
          min_btn: min_btn
        }, state, CONSTANTS);

      });

      sidebar_info.addEventListener('click', (e) => {
        // catch events to the locate button
        if (e.target.className === CONSTANTS.css.locate_btn) {
          // get the current project's feature data
          const current_project_i = state.active_project.getAttribute('data-index');
          const current_project = data.features[current_project_i];
          // switch the view to map if on list view
          if (state.active_view.id === CONSTANTS.css.list) {
            show_view(CONSTANTS.css.map);
          }
          map.panTo(current_project.geometry.coordinates);
        }
      });

      // hover styles for markers

      map.on('mouseenter', CONSTANTS.layers.projects, function (e) {
        // Change the cursor to a pointer when the mouse is over the projects layer
        map.getCanvas().style.cursor = 'pointer';

        // don't want mouseovers to change the opened popup when sidebar is open
        if (!state.sidebar_open) {
          hoverize_feature(e.features[0], state);
        }
      });

      map.on('mouseleave', CONSTANTS.layers.projects, deactivate.bind(this, state));

      map.on('mouseenter', CONSTANTS.layers.workshops, function (e) {
        // Change the cursor to a pointer when the mouse is over the projects layer
        map.getCanvas().style.cursor = 'pointer';

        // don't want mouseovers to change the opened popup when sidebar is open
        if (!state.sidebar_open) {
          hoverize_feature(e.features[0], state);
        }
      });

      map.on('mouseleave', CONSTANTS.layers.workshops, deactivate.bind(this, state));

      // deprecate the dev zone interactivity for now

      // map.on('mouseenter', CONSTANTS.layers.dev_zones, function (e) {
      //   const current_project = e.features[0].properties[CONSTANTS.projects_id_key];
      //   const corresponding_feature = data.features_map[current_project];

      //   // Change the cursor to a pointer when the mouse is over the projects layer
      //   map.getCanvas().style.cursor = 'pointer';

      //   // don't want mouseovers to change the opened popup when sidebar is open
      //   if (!state.sidebar_open) {
      //     hoverize_feature(corresponding_feature, state);
      //   }
      // });

      // map.on('mouseleave', CONSTANTS.layers.dev_zones, deactivate.bind(this, state));

    });

  </script>

</body>

</html>
